name: Run K6 Load Test on ECS

on:
  workflow_dispatch:
    inputs:
      app_folder:
        description: 'Application folder (e.g., app1, app2)'
        required: true
        default: 'app1'
      script_name:
        description: 'K6 script name (e.g., test1.js)'
        required: true
        default: 'test1.js'
      duration:
        description: 'Test duration (e.g., 30s, 5m)'
        required: false
        default: '1m'
      vus:
        description: 'Number of virtual users'
        required: false
        default: '10'

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 983610474809
  ECS_CLUSTER: k6-cluster-v3-983610474809
  TASK_DEFINITION: k6-task-983610474809
  S3_BUCKET: k6-artifacts-983610474809

jobs:
  run-k6-test:
    name: Execute K6 Load Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ------------------------------------------------------------
      # Network discovery (default VPC, subnets, security group)
      # ------------------------------------------------------------
      - name: Get default VPC and subnets
        id: vpc-info
        run: |
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=isDefault,Values=true" \
            --query 'Vpcs[0].VpcId' \
            --output text)

          echo "vpc-id=${VPC_ID}" >> $GITHUB_OUTPUT

          SUBNETS=$(aws ec2 describe-subnets \
            --filters "Name=vpc-id,Values=${VPC_ID}" \
            --query 'Subnets[].SubnetId' \
            --output text | tr '\t' ',')

          echo "subnet-ids=${SUBNETS}" >> $GITHUB_OUTPUT

          SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=vpc-id,Values=${VPC_ID}" "Name=group-name,Values=default" \
            --query 'SecurityGroups[0].GroupId' \
            --output text)

          echo "security-group-id=${SG_ID}" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------
      # Resolve task definition
      # ------------------------------------------------------------
      - name: Get latest task definition
        id: task-def
        run: |
          TASK_DEF_ARN=$(aws ecs describe-task-definition \
            --task-definition ${{ env.TASK_DEFINITION }} \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "task-def-arn=${TASK_DEF_ARN}" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------
      # Generate run ID
      # ------------------------------------------------------------
      - name: Generate run ID
        id: run-info
        run: |
          RUN_ID="$(date +%Y%m%d-%H%M%S)-${{ github.run_number }}"
          echo "run-id=${RUN_ID}" >> $GITHUB_OUTPUT
          echo "Run ID: ${RUN_ID}"

      # ------------------------------------------------------------
      # Run ECS Fargate task
      # ------------------------------------------------------------
      - name: Run ECS Fargate task
        id: run-task
        run: |
          TASK_ARN=$(aws ecs run-task \
            --cluster ${{ env.ECS_CLUSTER }} \
            --task-definition ${{ steps.task-def.outputs.task-def-arn }} \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={
              subnets=[${{ steps.vpc-info.outputs.subnet-ids }}],
              securityGroups=[${{ steps.vpc-info.outputs.security-group-id }}],
              assignPublicIp=ENABLED
            }" \
            --overrides '{
              "containerOverrides": [
                {
                  "name": "k6-runner",
                  "environment": [
                    { "name": "APP_FOLDER", "value": "${{ github.event.inputs.app_folder }}" },
                    { "name": "SCRIPT_NAME", "value": "${{ github.event.inputs.script_name }}" },
                    { "name": "K6_DURATION", "value": "${{ github.event.inputs.duration }}" },
                    { "name": "K6_VUS", "value": "${{ github.event.inputs.vus }}" },
                    { "name": "RUN_ID", "value": "${{ steps.run-info.outputs.run-id }}" },
                    { "name": "S3_BUCKET", "value": "${{ env.S3_BUCKET }}" },
                    { "name": "AWS_REGION", "value": "${{ env.AWS_REGION }}" },
                    { "name": "GITHUB_REPO_URL", "value": "${{ github.server_url }}/${{ github.repository }}.git" },
                    { "name": "GITHUB_BRANCH", "value": "${{ github.ref_name }}" },
                    { "name": "GITHUB_TOKEN", "value": "${{ secrets.GITHUB_TOKEN }}" },
                    { "name": "AUTH_HEADER", "value": "${{ secrets.AUTH_HEADER }}" }
                  ]
                }
              ]
            }' \
            --query 'tasks[0].taskArn' \
            --output text)

          echo "task-arn=${TASK_ARN}" >> $GITHUB_OUTPUT
          echo "ECS Task ARN: ${TASK_ARN}"

      # ------------------------------------------------------------
      # Wait for task completion
      # ------------------------------------------------------------
      - name: Wait for ECS task to complete
        run: |
          echo "Waiting for ECS task to complete..."
          aws ecs wait tasks-stopped \
            --cluster ${{ env.ECS_CLUSTER }} \
            --tasks ${{ steps.run-task.outputs.task-arn }}
          echo "Task completed"

      # ------------------------------------------------------------
      # Capture exit code
      # ------------------------------------------------------------
      - name: Get task exit code
        id: task-result
        run: |
          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster ${{ env.ECS_CLUSTER }} \
            --tasks ${{ steps.run-task.outputs.task-arn }} \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)

          echo "exit-code=${EXIT_CODE}" >> $GITHUB_OUTPUT
          echo "Task exit code: ${EXIT_CODE}"

          if [ "${EXIT_CODE}" != "0" ]; then
            echo "::error::K6 test failed with exit code ${EXIT_CODE}"
            exit 1
          fi

      # ------------------------------------------------------------
      # Results location
      # ------------------------------------------------------------
      - name: Print results location
        run: |
          S3_URL="https://s3.console.aws.amazon.com/s3/buckets/${{ env.S3_BUCKET }}?prefix=${{ github.event.inputs.app_folder }}/${{ steps.run-info.outputs.run-id }}/&region=${{ env.AWS_REGION }}"
          echo "Results available at:"
          echo "${S3_URL}"
          echo "::notice::K6 results: ${S3_URL}"

      # ------------------------------------------------------------
      # CloudWatch logs link
      # ------------------------------------------------------------
      - name: View CloudWatch logs
        if: always()
        run: |
          LOG_URL="https://console.aws.amazon.com/cloudwatch/home?region=${{ env.AWS_REGION }}#logsV2:log-groups/log-group/\$252Fecs\$252Fk6-logs-${{ env.AWS_ACCOUNT_ID }}"
          echo "CloudWatch Logs:"
          echo "${LOG_URL}"
          echo "::notice::View CloudWatch logs: ${LOG_URL}"
